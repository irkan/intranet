AUI.add("aui-scheduler-event-recorder",function(X){var M=X.Lang,a=M.isArray,v=M.isObject,am=M.isString,I=M.isUndefined,m=X.IO.prototype._serialize,t=M.toInt,ai=function(aA,az,A){return Math.min(Math.max(aA,az),A);},i=X.DataType.DateMath,av=",",au="-",d=".",at=" ",P="scheduler-event",Q="scheduler-event-recorder",B="activeView",w="allDay",c="arrow",aa="body",S="bodyContent",b="borderRadius",l="boundingBox",R="cancel",ae="click",s="constrain",V="content",ac="date",W="dateFormat",L="delete",Y="endDate",ar="event",q="footerContent",U="form",p="header",ad="isoTime",G="keydown",k="node",z="offsetHeight",al="offsetWidth",g="overlay",C="overlayOffset",N="px",aq="recorder",ap="rendered",e="region",f="right",af="save",H="scheduler",j="schedulerChange",T="shadow",an="startDate",y="strings",ao="submit",ag="template",ab="title",F="toolbar",h="top",Z="visibleChange",u=X.getClassName,n=u(P),r=u(P,ab),O=u(P,aq),aw=u(H,ar,aq,g),o=u(H,ar,aq,g,c),aj=u(H,ar,aq,g,c,h),ak=u(H,ar,aq,g,c,T),J=u(H,ar,aq,g,aa),ah=u(H,ar,aq,g,V),K=u(H,ar,aq,g,ac),D=u(H,ar,aq,g,U),ay=u(H,ar,aq,g,p),x=new X.Template('<div class="',ak," ",o,'"></div>','<div class="',o,'"></div>','<input type="hidden" name="startDate" value="{startDate}" />','<input type="hidden" name="endDate" value="{endDate}" />','<div class="',ay,'">','<input class="',ah,'" name="content" value="{content}" />',"</div>",'<div class="',J,'">','<label class="',K,'">{date}</label>',"</div>"),ax='<form class="'+D+'" id="schedulerEventRecorderForm"></form>';var E=X.Component.create({NAME:Q,ATTRS:{allDay:{value:false},content:{},duration:{value:60},dateFormat:{validator:am,value:"%a, %B %d"},event:{},eventClass:{valueFn:function(){return X.SchedulerEvent;}},strings:{value:{},setter:function(A){return X.merge({"delete":"Delete","description-hint":"e.g., Dinner at Brian's",cancel:"Cancel",description:"Description",edit:"Edit",save:"Save",when:"When"},A||{});},validator:v},overlay:{validator:v,value:{constrain:true,visible:false,width:300,zIndex:500}},overlayOffset:{value:[15,-38],validator:a},template:{value:x},toolbar:{setter:function(aA){var az=this;var A=az.get(y);return X.merge({children:[{handler:X.bind(az._handleSaveEvent,az),label:A[af]},{handler:X.bind(az._handleCancelEvent,az),label:A[R]},{handler:X.bind(az._handleDeleteEvent,az),label:A[L]}]},aA||{});},validator:v,value:{}}},EXTENDS:X.SchedulerEvent,prototype:{initializer:function(){var A=this;A.get(k).addClass(O);A.publish("cancel",{defaultFn:A._defCancelEventFn});A.publish("delete",{defaultFn:A._defDeleteEventFn});A.publish("edit",{defaultFn:A._defEditEventFn});A.publish("save",{defaultFn:A._defSaveEventFn});A.after(j,A._afterSchedulerChange);A[g]=new X.Overlay(A.get(g));A[F]=new X.Toolbar(A.get(F));A[g].on(Z,X.bind(A._onOverlayVisibleChange,A));},getOverlayContentNode:function(){var A=this;var az=A[g].get(l);return az.one(d+ah);},getUpdatedSchedulerEvent:function(aA){var A=this,aB=A.get(ar),az={silent:!aB},aC=A.serializeForm();if(!aB){aB=A.clone();}aB.set(H,A.get(H),{silent:true});aB.setAttrs(X.merge(aC,aA),az);return aB;},_afterSchedulerChange:function(aB){var A=this;var aA=aB.newVal;var az=aA.get(l);az.delegate(ae,X.bind(A._onClickSchedulerEvent,A),d+n);},_defCancelEventFn:function(az){var A=this;A.get(k).remove();A.hideOverlay();},_defDeleteEventFn:function(aA){var A=this;var az=A.get(H);az.removeEvents(A.get(ar));A.hideOverlay();az.syncEventsUI();},_defEditEventFn:function(aA){var A=this;var az=A.get(H);A.hideOverlay();az.syncEventsUI();},_defSaveEventFn:function(aA){var A=this;var az=A.get(H);az.addEvents(aA.newSchedulerEvent);A.hideOverlay();az.syncEventsUI();},_handleCancelEvent:function(az){var A=this;A.fire("cancel");az.preventDefault();},_handleClickOutSide:function(az){var A=this;A.fire("cancel");},_handleDeleteEvent:function(az){var A=this;A.fire("delete",{schedulerEvent:A.get(ar)});az.preventDefault();},_handleEscapeEvent:function(az){var A=this;if(A[g].get(ap)&&(az.keyCode==X.Event.KeyMap.ESC)){A.fire("cancel");az.preventDefault();}},_handleSaveEvent:function(aA){var A=this,az=A.get(ar)?"edit":"save";A.fire(az,{newSchedulerEvent:A.getUpdatedSchedulerEvent()});aA.preventDefault();},_onClickSchedulerEvent:function(aA){var A=this;var az=aA.currentTarget.getData(P);if(az){A.set(ar,az,{silent:true});A.showOverlay([aA.pageX,aA.pageY]);A.get(k).remove();}},_onOverlayVisibleChange:function(az){var A=this;if(az.newVal){A.populateForm();if(!A.get(ar)){var aA=A.getOverlayContentNode();if(aA){setTimeout(function(){aA.selectText();},0);}}}else{A.set(ar,null,{silent:true});A.get(k).remove();}},_onSubmitForm:function(az){var A=this;A._handleSaveEvent(az);},_renderOverlay:function(){var az=this;var aC=az.get(H);var aB=aC.get(l);var A=az.get(y);az[g].render(aB);az[F].render(aB);var aA=az[g].get(l);aA.addClass(aw);az[g].set(q,az[F].get(l));az.formNode=X.Node.create(ax);az[g].set(S,az.formNode);az.formNode.on(ao,X.bind(az._onSubmitForm,az));aC.get(l).on("clickoutside",X.bind(az._handleClickOutSide,az));},getFormattedDate:function(){var A=this;evt=(A.get(ar)||A);endDate=evt.get(Y),startDate=evt.get(an),formattedDate=evt._formatDate(startDate,A.get(W));if(evt.get(w)){return formattedDate;}formattedDate=formattedDate.concat(av);var aA=evt.get(H),az=(aA.get(B).get(ad)?i.toIsoTimeString:i.toUsTimeString);return[formattedDate,az(startDate),au,az(endDate)].join(at);},getTemplateData:function(){var az=this,A=az.get(y),aA=az.get(ar)||az,aB=aA.get(V);if(I(aB)){aB=A["description-hint"];}return{content:aB,date:az.getFormattedDate(),endDate:aA.get(Y).getTime(),startDate:aA.get(an).getTime()};},hideOverlay:function(){var A=this;A[g].hide();},populateForm:function(){var A=this;A.formNode.setContent(A.get(ag).parse(A.getTemplateData()));},serializeForm:function(){var A=this;return X.QueryString.parse(m(A.formNode.getDOM()));},showOverlay:function(aI){var aH=this,aE=aI.concat([]),aF=aH[g],aD=aF.get(l);if(!aH[g].get(ap)){aH._renderOverlay();}aF.show();aH.handleEscapeEvent=X.on(G,X.bind(aH._handleEscapeEvent,aH));var aG=aD.all(d+o),aC=aG.item(0),az=aC.get(z),aB=aC.get(al);
aG.removeClass(aj).show();aI[0]-=aD.get(al)*0.5;aI[1]-=aD.get(z)+az*0.5;var aA=aF.getConstrainedXY(aI);if(aA[1]!==aI[1]){aI[1]=aE[1]+az*0.5;aG.addClass(aj);}aI=aF.getConstrainedXY(aI);aF.set("xy",aI);var A=ai(aE[0]-aB*0.5,aI[0],aI[0]+aD.get(al));aG.setX(A);}}});X.SchedulerEventRecorder=E;},"@VERSION@",{skinnable:true,requires:["aui-scheduler-base","aui-template","aui-toolbar","io-form","querystring","overlay"]});